AWSTemplateFormatVersion: '2010-09-09'
Description: Deploy n8n with Docker on Ubuntu 24.04 and CloudFront Distribution

Parameters:
  InstanceType:
    Type: String
    Default: t3.micro
    Description: EC2 instance type

Mappings:
  RegionMap:
    ap-east-2:
      AMI: ami-016208b12b4e0d3d7
    us-east-1:
      AMI: ami-0ecb62995f68bb549

Resources:
  # VPC
  N8nVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.13.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: n8n-vpc

  # Internet Gateway
  N8nInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: n8n-igw

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref N8nVPC
      InternetGatewayId: !Ref N8nInternetGateway

  # Public Subnet
  N8nSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref N8nVPC
      CidrBlock: 10.13.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs:
              Ref: AWS::Region
      Tags:
        - Key: Name
          Value: n8n-public-subnet

  # Route Table
  N8nRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref N8nVPC
      Tags:
        - Key: Name
          Value: n8n-rt

  # Route to Internet
  N8nRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref N8nRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref N8nInternetGateway

  # Associate RouteTable
  N8nSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref N8nRouteTable
      SubnetId: !Ref N8nSubnet

  # Security Group
  N8nSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP (5678) access to n8n and SSM
      VpcId: !Ref N8nVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5678
          ToPort: 5678
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: "-1"
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: n8n-sg

  # IAM Role for SSM
  SSMInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Path: "/"

  SSMInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref SSMInstanceRole

  # EC2 Instance
  N8nInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !FindInMap [RegionMap, !Ref "AWS::Region", AMI]
      SubnetId: !Ref N8nSubnet
      SecurityGroupIds:
        - !Ref N8nSecurityGroup
      IamInstanceProfile: !Ref SSMInstanceProfile
      Tags:
        - Key: Name
          Value: n8n-ubuntu
      UserData:
        Fn::Base64: |
          #!/bin/bash
          exec > /var/log/user-data.log 2>&1
          set -eux

          export DEBIAN_FRONTEND=noninteractive
          apt-get update -y
          apt-get upgrade -y

          # Install Docker
          apt-get install -y ca-certificates curl gnupg lsb-release
          install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
          chmod a+r /etc/apt/keyrings/docker.asc
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
            $(. /etc/os-release && echo ${UBUNTU_CODENAME:-$VERSION_CODENAME}) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
          apt-get update -y
          apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
          systemctl enable docker && systemctl start docker

          docker volume create n8n_data
          docker run -d \
            --name n8n \
            -p 5678:5678 \
            -e GENERIC_TIMEZONE="Asia/Taipei" \
            -e TZ="Asia/Taipei" \
            -e N8N_BASIC_AUTH_ACTIVE="true" \
            -e N8N_BASIC_AUTH_USER="admin" \
            -e N8N_BASIC_AUTH_PASSWORD="supersecret" \
            -e N8N_PUSH_BACKEND="sse" \
            -v n8n_data:/home/node/.n8n \
            docker.n8n.io/n8nio/n8n:latest

  # CloudFront Distribution (managed policies)
  N8nCloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Origins:
          - Id: N8nOrigin
            DomainName: !GetAtt N8nInstance.PublicDnsName
            CustomOriginConfig:
              HTTPPort: 5678
              HTTPSPort: 443
              OriginProtocolPolicy: http-only
            OriginCustomHeaders:
              - HeaderName: Origin
                HeaderValue: !Join ["", ["http://", !GetAtt N8nInstance.PublicDnsName]]
        DefaultCacheBehavior:
          TargetOriginId: N8nOrigin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: ["GET","HEAD","OPTIONS","PUT","POST","PATCH","DELETE"]
          CachedMethods: ["GET","HEAD"]
          # Managed CachingDisabled
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
          # Managed AllViewerExceptHostHeader
          OriginRequestPolicyId: b689b0a8-53d0-40ab-baf2-68738e2966ac
        ViewerCertificate:
          CloudFrontDefaultCertificate: true
        PriceClass: PriceClass_200

Outputs:
  PublicIP:
    Description: Public IP address of the n8n instance
    Value: !GetAtt N8nInstance.PublicIp

  N8nURL:
    Description: Direct EC2 n8n URL
    Value: !Join ["", ["http://", !GetAtt N8nInstance.PublicDnsName, ":5678"]]

  CloudFrontURL:
    Description: Access n8n via CloudFront
    Value: !Join ["", ["https://", !GetAtt N8nCloudFrontDistribution.DomainName]]
